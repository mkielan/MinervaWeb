@model Minerva.Models.Web.Comment.ChatModel

@using res = Minerva.Resources

@{
    ViewBag.Title = @res.Layout.Comments;
}

<h2>@res.Layout.Comments</h2>
<div id="comments-@Model.ItemId" class="container">
    <ul id="discussion"></ul>
    <input type="text" id="message" class="form-control" />
    <input type="button" id="sendmessage" class="btn" value="@res.Layout.Send" />
    <input type="hidden" id="username" value="@Model.UserName"/>
    <input type="hidden" id="itemId" value="@Model.ItemId" />
    <div class="comments-alerts"></div>
</div>

@*  Script references. 
    Reference the SignalR library. *@

@Scripts.Render("~/bundles/jquery-signalR")

@section scripts {
    @*  Reference the autogenerated SignalR hub script. *@
    <script src="~/signalr/hubs"></script>
    @*  SignalR script to update the chat page and send messages.*@
    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var comments = $.connection.commentsHub;

            comments.client.addNewMessage = function (name, message, time) {
                $('#discussion').append('<li><strong>' + htmlEncode(name)
                    + '</strong>: ' + htmlEncode(message) + '; '+ htmlEncode(time) + '</li>');
            };
            
            comments.client.addErrorMessage = function (message) {
                var msg = '<div class="alert alert-danger alert-dismissable">';
                msg += '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>';
                msg += message + "</div>";

                $('.comments-alerts').slideUp(function () {
                    $('.comments-alerts').children().remove();
                    $('.comments-alerts').append(msg);
                    $('.comments-alerts').slideDown();
                });
            };

            // Start the connection.
            $.connection.hub.start().done(function () {
                comments.server.joinItemGroup($('#itemId').val());

                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    comments.server.send($('#username').val(), $('#itemId').val(), $('#message').val());

                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });
            });
        });

        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}